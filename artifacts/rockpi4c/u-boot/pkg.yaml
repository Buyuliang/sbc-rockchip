# References:
#   U-Boot:
#     - https://u-boot.readthedocs.io/en/latest
#   Broadcom/RaspberryPi
#     - https://github.com/u-boot/u-boot/blob/master/doc/board/broadcom/raspberrypi.rst
name: u-boot-rockpi4c
variant: scratch
shell: /toolchain/bin/bash
dependencies:
  - stage: base
  - stage: arm-trusted-firmware
steps:
  - sources:
      - url: https://ftp.denx.de/pub/u-boot/u-boot-{{ .uboot_version }}.tar.bz2
        destination: u-boot.tar.bz2
        sha256: "{{ .uboot_sha256 }}"
        sha512: "{{ .uboot_sha512 }}"
    env:
      SOURCE_DATE_EPOCH: {{ .BUILD_ARG_SOURCE_DATE_EPOCH }}
    prepare:
      # rock-pi-4c-rk3399
      - |
        mkdir -p /usr/bin \
          && ln -sf /toolchain/bin/env /usr/bin/env

        tar xf u-boot.tar.bz2 --strip-components=1
      - |
        patch -p0 < /pkg/patches/board-rock-pi-4-enable-spi-flash.patch
        patch -p0 < /pkg/patches/general-add-xtx-spi-nor-chips.patch
        patch -p0 < /pkg/patches/enable-boot-from-spi-flash.patch

        make rock-pi-4c-rk3399_defconfig
        sed -i "s/CONFIG_TOOLS_LIBCRYPTO=y/# CONFIG_TOOLS_LIBCRYPTO is not set/" .config
    build:
      - |
        make -j $(nproc) HOSTLDLIBS_mkimage="-lssl -lcrypto" BL31=/libs/arm-trusted-firmware/rockpi4/bl31.elf

        # create spi image
        # https://github.com/armbian/build/blob/09e416e31cc01ece4533a65f02a470a4c21b90ea/config/sources/families/include/rockchip64_common.inc#L173-L178
        tools/mkimage -n rk3399 -T rkspi -d tpl/u-boot-tpl.bin:spl/u-boot-spl.bin rkspi_tpl_spl.img
        dd if=/dev/zero of=rkspi_loader.img count=8128 status=none
        dd if=rkspi_tpl_spl.img of=rkspi_loader.img conv=notrunc status=none
        dd if=u-boot.itb of=rkspi_loader.img seek=768 conv=notrunc status=none
    install:
      - |
        mkdir -p /rootfs/artifacts/arm64/u-boot/rockpi4c
        cp u-boot-rockchip.bin /rootfs/artifacts/arm64/u-boot/rockpi4c

        cp rkspi_loader.img /rootfs/artifacts/arm64/u-boot/rockpi4c
finalize:
  - from: /rootfs
    to: /rootfs
